<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì±„ì  í˜ì´ì§€</title>
  <link rel="stylesheet" href="style.css" />

  <style>
    .question-line {
      display: flex; align-items: center; justify-content: flex-start;
      gap: 8px; flex-wrap: wrap;
    }
    .question-card {
      background: #f8f9ff; border: 1px solid #dde2f2; border-radius: 10px;
      padding: 8px 12px; margin-bottom: 8px;
    }
    .question-card h3 {
      margin: 0; font-size: 14px; color: #2a5adf; font-weight: 600;
      width: 55px; text-align: right;
    }
    .dual-inputs {
      display: flex; gap: 6px; align-items: center;
      flex-wrap: wrap;
    }
    .dual-inputs label {
      font-size: 13px; font-weight: 600; color: #333;
    }
    .dual-inputs input {
      width: 100px; padding: 5px; font-size: 13px;
      border: 1px solid #ccc; border-radius: 5px;
    }
    .choices {
      display: flex; align-items: center; gap: 4px;
    }
    .check-btn {
      background: #2a5adf; color: white; border: none;
      padding: 6px 10px; border-radius: 6px;
      cursor: pointer; font-weight: 600;
    }
    .check-btn.correct { background: #e4f9ec; color: #0b7a32; border: 1.5px solid #1a8f4c; }
    .check-btn.wrong { background: #ffe9e9; color: #c81c1c; border: 1.5px solid #d93025; }
    .result-inline {
      font-weight: bold; white-space: nowrap;
      min-width: 90px; text-align: right; margin-left: 8px;
      font-size: 13px;
    }
    .bottom-buttons { text-align: center; margin-top: 20px; }
    #check-all {
      background: #444; color: white; border: none;
      padding: 8px 14px; border-radius: 8px; font-size: 13px;
      cursor: pointer;
    }
    #check-all:hover { background: #222; }
  </style>
</head>

<body>
  <div class="container">
    <h1 id="page-title">ğŸ“˜ ì±„ì  í˜ì´ì§€</h1>
    <div id="question-container">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    <div class="bottom-buttons">
      <button id="check-all">ğŸ§® ëª¨ë‘ ì±„ì </button><br />
      <button onclick="window.location.href='index.html'" class="back-btn">â¬… ìª½ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwvdVkZm4EVUVeHaelSzQPrtFmOA2bB3A7HFMHEIbb42SbDFfNusYrsLyFbNakLmlMzcQ/exec";

function normalize(s) {
  return s.replace(/root/gi,"âˆš").replace(/ë£¨íŠ¸/g,"âˆš").replace(/\s+/g,"").trim();
}

/* âœ… íŠ¹ìˆ˜ ìœ í˜• ì±„ì  */
function gradeSpecialPair(correct, user1, user2, key1, key2) {
  const norm = normalize;
  const c = correct.replace(/\s+/g,"");
  const parts = Object.fromEntries(c.split(",").map(p => p.split(":").map(x => norm(x))));
  return parts[key1] && parts[key2] &&
         norm(parts[key1]) === norm(user1) &&
         norm(parts[key2]) === norm(user2);
}

document.addEventListener("DOMContentLoaded", async () => {
  const page = new URLSearchParams(window.location.search).get("page");
  const title = document.getElementById("page-title");
  const container = document.getElementById("question-container");
  if (!page) { container.innerHTML = "<p>âŒ ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.</p>"; return; }
  title.textContent = `ğŸ“˜ ${page}ìª½ ì±„ì `;

  try {
    const res = await fetch(API_URL);
    const data = await res.json();
    const filtered = Object.entries(data).filter(([_, q]) => q.page == page).map(([id, q]) => ({ id, ...q }));
    if (filtered.length === 0) { container.innerHTML = "<p>âŒ í•´ë‹¹ ìª½ì˜ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>"; return; }

    container.innerHTML = filtered.map(q => {
      const type = q.type?.trim() || "";
      const ans = q.ans?.trim() || "";
      let inputHTML = "";

      // âœ… íŠ¹ìˆ˜ ìœ í˜• ì…ë ¥ì¹¸ 2ê°œ
      const noSpaceAns = ans.replace(/\s+/g,"");
      if (noSpaceAns.includes("ëª«:") && noSpaceAns.includes("ë‚˜ë¨¸ì§€:")) {
        inputHTML = `
          <div class="dual-inputs">
            <label>ëª«:</label><input type="text" class="ans1" />
            <label>ë‚˜ë¨¸ì§€:</label><input type="text" class="ans2" />
          </div>`;
      }
      else if (noSpaceAns.includes("ì‹¤ìˆ˜ë¶€ë¶„:") && noSpaceAns.includes("í—ˆìˆ˜ë¶€ë¶„:")) {
        inputHTML = `
          <div class="dual-inputs">
            <label>ì‹¤ìˆ˜ë¶€ë¶„:</label><input type="text" class="ans1" />
            <label>í—ˆìˆ˜ë¶€ë¶„:</label><input type="text" class="ans2" />
          </div>`;
      }
      else if (noSpaceAns.includes("ìµœëŒ“ê°’:") && noSpaceAns.includes("ìµœì†Ÿê°’:")) {
        inputHTML = `
          <div class="dual-inputs">
            <label>ìµœëŒ“ê°’:</label><input type="text" class="ans1" />
            <label>ìµœì†Ÿê°’:</label><input type="text" class="ans2" />
          </div>`;
      }
      // âœ… ê°ê´€ì‹ / ë³µìˆ˜í˜•
      else if (type === "ê°ê´€ì‹") {
        const opts = ["â‘ ","â‘¡","â‘¢","â‘£","â‘¤"];
        inputHTML = `<div class="choices">${opts.map(o=>`<label><input type="radio" name="${q.id}" value="${o}">${o}</label>`).join("")}</div>`;
      }
      else if (type === "ê°ê´€ì‹(ë³µìˆ˜í˜•)") {
        const opts = ["â‘ ","â‘¡","â‘¢","â‘£","â‘¤"];
        inputHTML = `<div class="choices">${opts.map(o=>`
          <label><input type="checkbox" name="${q.id}" value="${o}">${o}</label>
        `).join("")}</div>`;
      }
      // âœ… ê¸°ë³¸ ë‹¨ë‹µí˜•
      else {
        inputHTML = `<input type="text" class="answer-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" />`;
      }

      return `
        <div class="question-card" data-id="${q.id}">
          <div class="question-line">
            <h3>${q.id.replace("q","")}</h3>
            ${inputHTML}
            <button class="check-btn">ì±„ì </button>
            <span class="result-inline"></span>
          </div>
          <input type="hidden" class="correct-answer" value="${ans}" />
          <input type="hidden" class="answer-type" value="${type}" />
        </div>`;
    }).join("");

    /* âœ… ì±„ì  ë¡œì§ */
    function gradeQuestion(card) {
      const btn = card.querySelector(".check-btn");
      const result = card.querySelector(".result-inline");
      const correct = card.querySelector(".correct-answer").value.trim();
      const ans1 = card.querySelector(".ans1")?.value.trim() || "";
      const ans2 = card.querySelector(".ans2")?.value.trim() || "";
      const type = card.querySelector(".answer-type").value.trim();

      const cNoSpace = correct.replace(/\s+/g,"");

      // ğŸ”¸ ëª«/ë‚˜ë¨¸ì§€
      if (cNoSpace.includes("ëª«:") && cNoSpace.includes("ë‚˜ë¨¸ì§€:")) {
        return gradeSpecialPair(correct, ans1, ans2, "ëª«", "ë‚˜ë¨¸ì§€") ? pass() : fail();
      }
      // ğŸ”¸ ì‹¤ìˆ˜/í—ˆìˆ˜
      if (cNoSpace.includes("ì‹¤ìˆ˜ë¶€ë¶„:") && cNoSpace.includes("í—ˆìˆ˜ë¶€ë¶„:")) {
        return gradeSpecialPair(correct, ans1, ans2, "ì‹¤ìˆ˜ë¶€ë¶„", "í—ˆìˆ˜ë¶€ë¶„") ? pass() : fail();
      }
      // ğŸ”¸ ìµœëŒ“/ìµœì†Ÿ
      if (cNoSpace.includes("ìµœëŒ“ê°’:") && cNoSpace.includes("ìµœì†Ÿê°’:")) {
        return gradeSpecialPair(correct, ans1, ans2, "ìµœëŒ“ê°’", "ìµœì†Ÿê°’") ? pass() : fail();
      }

      // ğŸ”¸ ê°ê´€ì‹(ë³µìˆ˜í˜•)
      if (type === "ê°ê´€ì‹(ë³µìˆ˜í˜•)") {
        const selected = [...card.querySelectorAll("input[type='checkbox']")].filter(c=>c.checked).map(c=>c.value.trim()).sort().join(",");
        const correctSet = correct.split(/[, ]+/).map(v=>v.trim()).filter(v=>v).sort().join(",");
        if (!selected) return fail();
        return selected === correctSet ? pass() : fail();
      }

      // ğŸ”¸ ì¼ë°˜ ì±„ì 
      const userAns = card.querySelector(".answer-input")?.value.trim() || "";
      return normalize(userAns) === normalize(correct) ? pass() : fail();

      function pass(){ result.textContent="âœ… ì •ë‹µ!"; result.className="result-inline correct"; btn.classList.add("correct"); btn.textContent="O"; disableAll(); }
      function fail(){ result.textContent="âŒ ì˜¤ë‹µ.."; result.className="result-inline wrong"; btn.classList.add("wrong"); btn.textContent="X"; disableAll(); }
      function disableAll(){ btn.disabled=true; card.classList.add("graded"); card.querySelectorAll("input").forEach(i=>i.disabled=true); }
    }

    document.querySelectorAll(".check-btn").forEach(btn=>{
      btn.addEventListener("click",()=>gradeQuestion(btn.closest(".question-card")));
    });
    document.getElementById("check-all").addEventListener("click",()=>{
      document.querySelectorAll(".question-card").forEach(card=>{
        const btn = card.querySelector(".check-btn");
        if (btn && !btn.disabled) gradeQuestion(card);
      });
    });

  } catch(err){ container.innerHTML="<p style='color:red;'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>"; }
});
</script>
</body>
</html>
