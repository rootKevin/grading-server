<!DOCTYPE html>
<html lang="ko">
  <!-- v1.253 (ë³€ìˆ˜ëŒ€ì…í˜•: ë¼ë²¨+ë‹¤ì¤‘ì…ë ¥ ì¶”ê°€, ê¸°ì¡´ ëª¨ë“  ê¸°ëŠ¥ ìœ ì§€) -->
  <!-- v1.252 (Dì—´ í•„í„° + ê¸°ì¡´ ê¸°ëŠ¥ ì™„ì „ ë³µêµ¬í˜•) -->
  <!-- v1.25 (ë“±ì‹í˜•Â·ë³€ìˆ˜ëŒ€ì…í˜•ë§Œ ì±„ì  ê°€ëŠ¥, Dì—´ ê¸°ë°˜ í™œì„±í™”) -->
  <!-- v1.23 (ì†Œë¬¸í•­ ìë™ í¬ê¸° ì¡°ì • ë²„ì „) -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì±„ì  í˜ì´ì§€</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .question-line{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .question-card{background:#f8f9ff;border:1px solid #dde2f2;border-radius:10px;padding:8px 12px;margin-bottom:8px}
    .question-card h3{margin:0;font-size:14px;color:#2a5adf;font-weight:600;width:55px;text-align:right}
    .dual-inputs,.multi-inputs,.var-inputs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .dual-inputs label,.multi-inputs label,.var-inputs label{font-size:13px;font-weight:600;color:#333}
    .dual-inputs input,.multi-inputs input,.var-inputs input{width:90px;padding:4px;font-size:13px;border:1px solid #ccc;border-radius:5px}
    .multi-inputs input.small-input{width:45px;font-size:12px}
    .answer-input.disabled{background:#eee;color:#666;border:1px solid #ccc;cursor:not-allowed}
    .check-btn{background:#2a5adf;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:600}
    .check-btn.correct{background:#e4f9ec;color:#0b7a32;border:1.5px solid #1a8f4c}
    .check-btn.wrong{background:#ffe9e9;color:#c81c1c;border:1.5px solid #d93025}
    .result-inline{font-weight:bold;white-space:nowrap;min-width:90px;text-align:right;margin-left:8px;font-size:13px}
    .bottom-buttons{text-align:center;margin-top:20px}
    #check-all{background:#444;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:13px;cursor:pointer}
    #check-all:hover{background:#222}
  </style>
</head>

<body>
  <div class="container">
    <h1 id="page-title">ğŸ“˜ ì±„ì  í˜ì´ì§€</h1>
    <div id="question-container">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    <div class="bottom-buttons">
      <button id="check-all">ğŸ§® ëª¨ë‘ ì±„ì </button><br />
      <button onclick="window.location.href='index.html'" class="back-btn">â¬… ìª½ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwvdVkZm4EVUVeHaelSzQPrtFmOA2bB3A7HFMHEIbb42SbDFfNusYrsLyFbNakLmlMzcQ/exec";

/* ê³µí†µ ì •ê·œí™” */
function normalize(s){
  return (s||"")
    .replace(/root/gi,"âˆš").replace(/ë£¨íŠ¸/g,"âˆš")
    .replace(/âˆ’/g,"-").replace(/Ã—/g,"*").replace(/\*/g,"")
    .replace(/\s+/g,"").replace(/,$/,"").replace(/^,/,"").trim();
}

/* ëª«/ë‚˜ë¨¸ì§€, ì‹¤ìˆ˜/í—ˆìˆ˜, ìµœëŒ“/ìµœì†Ÿ key:value ì±„ì  */
function gradeSpecialPair(correct,user1,user2,key1,key2){
  const norm=normalize;
  const parts=Object.fromEntries(
    correct.replace(/\s+/g,"").split(",").map(p=>p.split(":").map(x=>norm(x)))
  );
  return parts[key1]&&parts[key2]&&norm(parts[key1])===norm(user1)&&norm(parts[key2])===norm(user2);
}

/* ë³€ìˆ˜ ëŒ€ì…í˜• íŒŒì„œ: "í‚¤=ê°’" ìŒì„ ìˆœì„œëŒ€ë¡œ ì¶”ì¶œ (í•œê¸€/ì˜ë¬¸ í‚¤ ì§€ì›) */
function parseKeyValuePairs(text){
  const pairs=[...String(text).matchAll(/([a-zA-Zê°€-í£]+)\s*=\s*([^,]+)/g)];
  return pairs.map(([,key,val])=>[key.trim(),normalize(val)]);
}

document.addEventListener("DOMContentLoaded",async()=>{
  const page=new URLSearchParams(window.location.search).get("page");
  const title=document.getElementById("page-title");
  const container=document.getElementById("question-container");
  if(!page){container.innerHTML="<p>âŒ ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.</p>";return;}
  title.textContent=`ğŸ“˜ ${page}ìª½ ì±„ì `;

  try{
    const res=await fetch(API_URL);
    const data=await res.json();
    const filtered=Object.entries(data).filter(([_,q])=>q.page==page).map(([id,q])=>({id,...q}));
    if(filtered.length===0){container.innerHTML="<p>âŒ í•´ë‹¹ ìª½ì˜ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";return;}

    container.innerHTML=filtered.map(q=>{
      const type=(q.type||"").trim(); // Dì—´: ë‹µ ìœ í˜•
      const ans =(q.ans ||"").trim();
      let inputHTML="";

      /* â‘  ë³€ìˆ˜ ëŒ€ì…í˜•: ë¼ë²¨+ë‹¤ì¤‘ ì…ë ¥ì¹¸ */
      if(type==="ë³€ìˆ˜ ëŒ€ì…í˜•"){
        const pairs=parseKeyValuePairs(ans);
        inputHTML=`<div class="var-inputs">${
          pairs.map(([key])=>`<label>${key}</label><input type="text" class="var-input" data-key="${key}" />`).join("")
        }</div>`;
      }
      /* â‘¡ íŠ¹ìˆ˜ ìœ í˜•: ëª«/ë‚˜ë¨¸ì§€, ì‹¤ìˆ˜/í—ˆìˆ˜, ìµœëŒ“/ìµœì†Ÿ */
      else if(/ëª«\s*:|ë‚˜ë¨¸ì§€\s*:/.test(ans)){
        inputHTML=`<div class="dual-inputs">
          <label>ëª«</label><input type="text" class="ans1" />
          <label>ë‚˜ë¨¸ì§€</label><input type="text" class="ans2" />
        </div>`;
      }else if(/ì‹¤ìˆ˜ë¶€ë¶„\s*:|í—ˆìˆ˜ë¶€ë¶„\s*:/.test(ans)){
        inputHTML=`<div class="dual-inputs">
          <label>ì‹¤ìˆ˜ë¶€ë¶„</label><input type="text" class="ans1" />
          <label>í—ˆìˆ˜ë¶€ë¶„</label><input type="text" class="ans2" />
        </div>`;
      }else if(/ìµœëŒ“ê°’\s*:|ìµœì†Ÿê°’\s*:/.test(ans)){
        inputHTML=`<div class="dual-inputs">
          <label>ìµœëŒ“ê°’</label><input type="text" class="ans1" />
          <label>ìµœì†Ÿê°’</label><input type="text" class="ans2" />
        </div>`;
      }
      /* â‘¢ ì†Œë¬¸í•­í˜•: (1)(2)(3)â€¦ ë˜ëŠ” (ê°€)(ë‚˜)(ë‹¤)â€¦ */
      else if(/\(\d+\)|\([ê°€-ì‚¬]\)/.test(ans)){
        const tokens=ans.match(/\((\d+|[ê°€-ì‚¬])\)/g)||[];
        const isMany=tokens.length>=5?"small-input":"";
        inputHTML=`<div class="multi-inputs">${
          tokens.map((t,i)=>`<label>${t}</label><input type="text" class="subans ${isMany}" data-index="${i}" />`).join("")
        }</div>`;
      }
      /* â‘£ ê°ê´€ì‹/ë³µìˆ˜í˜• */
      else if(type==="ê°ê´€ì‹"){
        const opts=["â‘ ","â‘¡","â‘¢","â‘£","â‘¤"];
        inputHTML=`<div class="choices">${
          opts.map(o=>`<label><input type="radio" name="${q.id}" value="${o}">${o}</label>`).join("")
        }</div>`;
      }else if(type==="ê°ê´€ì‹(ë³µìˆ˜í˜•)"){
        const opts=["â‘ ","â‘¡","â‘¢","â‘£","â‘¤"];
        inputHTML=`<div class="choices">${
          opts.map(o=>`<label><input type="checkbox" name="${q.id}" value="${o}">${o}</label>`).join("")
        }</div>`;
      }
      /* â‘¤ ë“±ì‹í˜•/ì¼ë°˜ ë‹¨ë‹µí˜• */
      else if(type==="ë“±ì‹í˜•"){
        inputHTML=`<input type="text" class="answer-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" />`;
      }else{
        /* ì±„ì  ë¶ˆê°€ëŠ¥ ìœ í˜•(ë¬¸ì¥í˜•/ë¶€ë“±ì‹í˜• ë“±) */
        inputHTML=`<input type="text" class="answer-input disabled" value="ì±„ì  ë¶ˆê°€ëŠ¥ ìœ í˜•" disabled />`;
      }

      /* ë²„íŠ¼ì€ 'ì±„ì  ê°€ëŠ¥í•œ ì…ë ¥'ì—ë§Œ í™œì„±í™” */
      const canGrade = (
        type==="ë³€ìˆ˜ ëŒ€ì…í˜•" || type==="ë“±ì‹í˜•" ||
        type==="ê°ê´€ì‹" || type==="ê°ê´€ì‹(ë³µìˆ˜í˜•)" ||
        /ëª«\s*:|ë‚˜ë¨¸ì§€\s*:/.test(ans) ||
        /ì‹¤ìˆ˜ë¶€ë¶„\s*:|í—ˆìˆ˜ë¶€ë¶„\s*:/.test(ans) ||
        /ìµœëŒ“ê°’\s*:|ìµœì†Ÿê°’\s*:/.test(ans) ||
        /\(\d+\)|\([ê°€-ì‚¬]\)/.test(ans)
      );

      return `
        <div class="question-card" data-id="${q.id}">
          <div class="question-line">
            <h3>${q.id.replace("q","")}</h3>
            ${inputHTML}
            <button class="check-btn"${canGrade?"":" disabled"}>ì±„ì </button>
            <span class="result-inline"></span>
          </div>
          <input type="hidden" class="correct-answer" value="${ans}" />
          <input type="hidden" class="answer-type" value="${type}" />
        </div>`;
    }).join("");

    /* ì±„ì  ë¡œì§ */
    function gradeQuestion(card){
      const btn=card.querySelector(".check-btn");
      const result=card.querySelector(".result-inline");
      const correct=card.querySelector(".correct-answer").value.trim();
      const type=card.querySelector(".answer-type").value.trim();
      const norm=normalize;

      /* ê°ê´€ì‹ (ë‹¨ì¼) */
      if(type==="ê°ê´€ì‹"){
        const selected=card.querySelector("input[type=radio]:checked")?.value;
        return (selected===correct)?pass():fail();
      }
      /* ê°ê´€ì‹(ë³µìˆ˜í˜•): ì²´í¬í•œ ìˆœì„œë¥¼ ê·¸ëŒ€ë¡œ ì´ì–´ë¶™ì¸ ë¬¸ìì—´ë¡œ ë¹„êµ(ë°ì´í„°ë„ ê°™ì€ í˜•ì‹ì´ì–´ì•¼ í•¨) */
      if(type==="ê°ê´€ì‹(ë³µìˆ˜í˜•)"){
        const checked=[...card.querySelectorAll("input[type=checkbox]:checked")].map(i=>i.value).join("");
        return (checked===correct)?pass():fail();
      }
      /* ë³€ìˆ˜ ëŒ€ì…í˜•: ë¼ë²¨ë³„ 1:1 ë¹„êµ */
      if(type==="ë³€ìˆ˜ ëŒ€ì…í˜•"){
        const corrPairs=new Map(parseKeyValuePairs(correct));
        const inputs=[...card.querySelectorAll(".var-input")];
        if(inputs.length===0) return fail();
        const ok=inputs.every(inp=>{
          const key=inp.dataset.key;
          const val=norm(inp.value);
          return corrPairs.has(key)&&corrPairs.get(key)===val;
        });
        return ok?pass():fail();
      }
      /* íŠ¹ìˆ˜ ìœ í˜• */
      const ans1=card.querySelector(".ans1")?.value.trim()||"";
      const ans2=card.querySelector(".ans2")?.value.trim()||"";
      if(/ëª«\s*:|ë‚˜ë¨¸ì§€\s*:/.test(correct)){
        return gradeSpecialPair(correct,ans1,ans2,"ëª«","ë‚˜ë¨¸ì§€")?pass():fail();
      }
      if(/ì‹¤ìˆ˜ë¶€ë¶„\s*:|í—ˆìˆ˜ë¶€ë¶„\s*:/.test(correct)){
        return gradeSpecialPair(correct,ans1,ans2,"ì‹¤ìˆ˜ë¶€ë¶„","í—ˆìˆ˜ë¶€ë¶„")?pass():fail();
      }
      if(/ìµœëŒ“ê°’\s*:|ìµœì†Ÿê°’\s*:/.test(correct)){
        return gradeSpecialPair(correct,ans1,ans2,"ìµœëŒ“ê°’","ìµœì†Ÿê°’")?pass():fail();
      }
      /* ì†Œë¬¸í•­í˜• */
      const subInputs=card.querySelectorAll(".subans");
      if(subInputs.length>0){
        const correctParts=correct.replace(/\)\s*/g,") ")
          .split(/\(\d+\)|\([ê°€-ì‚¬]\)/)
          .map(x=>norm(x.replace(/^\)|\)$/g,""))).filter(Boolean);
        const userParts=[...subInputs].map(i=>norm(i.value));
        if(correctParts.length!==userParts.length) return fail();
        return correctParts.every((c,i)=>c===userParts[i])?pass():fail();
      }
      /* ë“±ì‹í˜•/ì¼ë°˜ ë‹¨ë‹µí˜• */
      if(type==="ë“±ì‹í˜•"){
        const userAns=norm(card.querySelector(".answer-input")?.value.trim()||"");
        return (userAns===norm(correct))?pass():fail();
      }

      /* ì—¬ê¸°ê¹Œì§€ ì•ˆ ê±¸ë¦¬ë©´ ì±„ì  ë¶ˆê°€ */
      result.textContent="ì±„ì  ë¶ˆê°€ëŠ¥";
      result.className="result-inline";
      return;

      function pass(){result.textContent="âœ… ì •ë‹µ!";result.className="result-inline correct";btn.classList.add("correct");btn.textContent="O";disableAll();}
      function fail(){result.textContent="âŒ ì˜¤ë‹µ..";result.className="result-inline wrong";btn.classList.add("wrong");btn.textContent="X";disableAll();}
      function disableAll(){btn.disabled=true;card.classList.add("graded");card.querySelectorAll("input").forEach(i=>i.disabled=true);}
    }

    document.querySelectorAll(".check-btn").forEach(btn=>{
      btn.addEventListener("click",()=>gradeQuestion(btn.closest(".question-card")));
    });
    document.getElementById("check-all").addEventListener("click",()=>{
      document.querySelectorAll(".question-card").forEach(card=>{
        const btn=card.querySelector(".check-btn");
        if(btn && !btn.disabled) gradeQuestion(card);
      });
    });

  }catch(err){
    container.innerHTML="<p style='color:red;'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
  }
});
</script>
</body>
</html>
