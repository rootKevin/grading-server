<!DOCTYPE html>
<html lang="ko">
  <!-- v1.2564 (ë°©ì •ì‹(nê°œ): ì¶”ê°€ì¹¸ë„ ì±„ì  í¬í•¨, 'ì‹¤ê·¼/í—ˆê·¼'ê¹Œì§€ ë©€í‹°ì…‹ ë¹„êµ) -->
  <!-- v1.2562 (ë°©ì •ì‹(nê°œ): ë“±í˜¸ê°œìˆ˜+nì¹¸ ìƒì„±, ë§ˆì§€ë§‰ nì¹¸ ë¼ë²¨Â·placeholder ì—†ìŒ, ê¸°ì¡´ v1.2561 ê¸°ëŠ¥ ìœ ì§€) -->
  <!-- v1.2561 (ì…ë ¥ì¹¸ 5ê°œ ì´ìƒ small-input ì ìš©) -->
  <!-- v1.255 (ë³€ìˆ˜ëŒ€ì…í˜•(ì—°ë¦½ë°©ì •ì‹) ë©€í‹°ì…‹ ë¹„êµ) -->
  <!-- v1.254 (ë³€ìˆ˜ëŒ€ì…í˜•(ë°©ì •ì‹) ìˆœì„œë¬´ê´€ ë¹„êµ) -->
  <!-- v1.253 (ë³€ìˆ˜ëŒ€ì…í˜• ë¼ë²¨+ë‹¤ì¤‘ì…ë ¥ ì¶”ê°€, ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€) -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì±„ì  í˜ì´ì§€</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .question-line{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .question-card{background:#f8f9ff;border:1px solid #dde2f2;border-radius:10px;padding:8px 12px;margin-bottom:8px}
    .question-card h3{margin:0;font-size:14px;color:#2a5adf;font-weight:600;width:55px;text-align:right}
    .dual-inputs,.multi-inputs,.var-inputs{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .dual-inputs label,.multi-inputs label,.var-inputs label{font-size:13px;font-weight:600;color:#333}
    .dual-inputs input,.multi-inputs input,.var-inputs input{width:90px;padding:4px;font-size:13px;border:1px solid #ccc;border-radius:5px}
    .multi-inputs input.small-input,.var-inputs input.small-input{width:45px;font-size:12px}
    .answer-input.disabled{background:#eee;color:#666;border:1px solid #ccc;cursor:not-allowed}
    .check-btn{background:#2a5adf;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:600}
    .check-btn.correct{background:#e4f9ec;color:#0b7a32;border:1.5px solid #1a8f4c}
    .check-btn.wrong{background:#ffe9e9;color:#c81c1c;border:1.5px solid #d93025}
    .result-inline{font-weight:bold;white-space:nowrap;min-width:90px;text-align:right;margin-left:8px;font-size:13px}
    .bottom-buttons{text-align:center;margin-top:20px}
    #check-all{background:#444;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-size:13px;cursor:pointer}
    #check-all:hover{background:#222}
  </style>
</head>

<body>
  <div class="container">
    <h1 id="page-title">ğŸ“˜ ì±„ì  í˜ì´ì§€</h1>
    <div id="question-container">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
    <div class="bottom-buttons">
      <button id="check-all">ğŸ§® ëª¨ë‘ ì±„ì </button><br />
      <button onclick="window.location.href='index.html'" class="back-btn">â¬… ìª½ ì„ íƒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
  </div>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwvdVkZm4EVUVeHaelSzQPrtFmOA2bB3A7HFMHEIbb42SbDFfNusYrsLyFbNakLmlMzcQ/exec";

/* ê³µí†µ ì •ê·œí™” */
function normalize(s){
  return (s||"")
    .replace(/root/gi,"âˆš").replace(/ë£¨íŠ¸/g,"âˆš")
    .replace(/âˆ’/g,"-").replace(/Ã—/g,"*").replace(/\*/g,"")
    // "x=... ë˜ëŠ” x=..." ì‚¬ì´ì— ì½¤ë§ˆë¥¼ ë„£ì–´ ìº¡ì²˜ ê²½ê³„ ìƒì„±
    .replace(/\s*ë˜ëŠ”\s*(?=[a-zA-Zê°€-í£]+\s*=)/g, ",")
    // ì „ê° ì‰¼í‘œ ë“± í†µì¼
    .replace(/ï¼Œ/g, ",")
    // ì‰¼í‘œ ì–‘ìª½ ê³µë°± ì œê±°
    .replace(/\s*,\s*/g, ",")
    // ëª¨ë“  ì”ì—¬ ê³µë°± ì œê±°
    .replace(/\s+/g,"")
    // ì„ ë‘/ë§ë¯¸ ì‰¼í‘œ ì œê±°
    .replace(/,$/,"").replace(/^,/,"")
    .trim();
}



/* íŠ¹ìˆ˜ key:value ìŒ ì±„ì (ëª«/ë‚˜ë¨¸ì§€, ì‹¤ìˆ˜/í—ˆìˆ˜, ìµœëŒ“/ìµœì†Ÿ) */
function gradeSpecialPair(correct,user1,user2,key1,key2){
  const norm=normalize;
  const parts=Object.fromEntries(
    correct.replace(/\s+/g,"").split(",").map(p=>p.split(":").map(x=>norm(x)))
  );
  return parts[key1]&&parts[key2]&&norm(parts[key1])===norm(user1)&&norm(parts[key2])===norm(user2);
}

/* ë³€ìˆ˜ ëŒ€ì…í˜• ê¸°ë³¸ íŒŒì„œ ("í‚¤=ê°’" ë‚˜ì—´) */
function parseKeyValuePairs(text){
  const pairs=[...String(text).matchAll(/([a-zA-Zê°€-í£]+)\s*=\s*([^,]+)/g)];
  return pairs.map(([,key,val])=>[key.trim(),normalize(val)]);
}

/* ì—°ë¦½ë°©ì •ì‹: í•´ ê°’ ë©€í‹°ì…‹ ë¹„êµ */
function gradeSystemEquationAsMultiset(correct, inputs){
  const norm=normalize;
  const corrValues=[...correct.matchAll(/=\s*([^,}]+)/g)].map(m=>norm(m[1]));
  const userValues=inputs.map(v=>norm(v));
  if(userValues.length!==corrValues.length) return false;
  return [...userValues].sort().join(",") === [...corrValues].sort().join(",");
}

document.addEventListener("DOMContentLoaded",async()=>{
  const page=new URLSearchParams(window.location.search).get("page");
  const title=document.getElementById("page-title");
  const container=document.getElementById("question-container");
  if(!page){container.innerHTML="<p>âŒ ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.</p>";return;}
  title.textContent=`ğŸ“˜ ${page}ìª½ ì±„ì `;

  try{
    const res=await fetch(API_URL);
    const data=await res.json();
    const filtered=Object.entries(data).filter(([_,q])=>q.page==page).map(([id,q])=>({id,...q}));
    if(filtered.length===0){container.innerHTML="<p>âŒ í•´ë‹¹ ìª½ì˜ ë¬¸í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";return;}

    container.innerHTML=filtered.map(q=>{
      const type=(q.type||"").trim();
      const ans =(q.ans ||"").trim();
      let inputHTML="";

      /* â‘  ë³€ìˆ˜ ëŒ€ì…í˜•(ì—°ë¦½ë°©ì •ì‹) â€” ê¸°ì¡´ ìœ ì§€ */
      if(type==="ë³€ìˆ˜ ëŒ€ì…í˜•(ì—°ë¦½ë°©ì •ì‹)"){
        const labels=[...ans.matchAll(/([a-zA-Zê°€-í£]+)\s*=/g)].map(m=>m[1]);
        const isMany=labels.length>=5?"small-input":"";
        inputHTML=`<div class="var-inputs">${
          labels.map(l=>`<label>${l}</label><input type="text" class="var-system ${isMany}" data-key="${l}" />`).join("")
        }</div>`;
      }
      /* â‘¡ ë³€ìˆ˜ ëŒ€ì…í˜•(ë°©ì •ì‹)(nê°œ) â€” ì‹ ê·œ ì¶”ê°€ (ë“±í˜¸ ê°œìˆ˜ + n, ë§ˆì§€ë§‰ nì¹¸ ë¼ë²¨ ì—†ìŒ) */
      else if(/^ë³€ìˆ˜\s*ëŒ€ì…í˜•\(ë°©ì •ì‹\)\(\d+ê°œ\)$/.test(type)){
        const n=parseInt(type.match(/\((\d+)ê°œ\)/)[1]);
        const baseLabels=[...ans.matchAll(/([a-zA-Zê°€-í£]+)\s*=/g)].map(m=>m[1]); // ë“±í˜¸ ê°œìˆ˜ë§Œí¼
        const total=baseLabels.length + n;
        const isMany=total>=5?"small-input":"";
        inputHTML=`<div class="var-inputs">` +
          baseLabels.map(v=>`<label>${v}</label><input type="text" class="var-eq ${isMany}" data-key="${v}" />`).join("") +
          Array.from({length:n}).map(()=>`<input type="text" class="extra-eq ${isMany}" />`).join("") +
          `</div>`;
      }
      /* â‘¢ ë³€ìˆ˜ ëŒ€ì…í˜•(ë°©ì •ì‹) â€” ê¸°ì¡´ ìœ ì§€ */
      else if(type==="ë³€ìˆ˜ ëŒ€ì…í˜•(ë°©ì •ì‹)"){
        const labels=[...ans.matchAll(/([a-zA-Zê°€-í£]+)\s*=/g)].map(m=>m[1]);
        const isMany=labels.length>=5?"small-input":"";
        inputHTML=`<div class="var-inputs">${
          labels.map(l=>`<label>${l}</label><input type="text" class="var-eq ${isMany}" data-key="${l}" />`).join("")
        }</div>`;
      }
      /* â‘£ ì†Œë¬¸í•­í˜• â€” ê¸°ì¡´ ìœ ì§€ */
      else if(/\(\d+\)|\([ê°€-ì‚¬]\)/.test(ans)){
        const tokens=ans.match(/\((\d+|[ê°€-ì‚¬])\)/g)||[];
        const isMany=tokens.length>=5?"small-input":"";
        inputHTML=`<div class="multi-inputs">${
          tokens.map((t,i)=>`<label>${t}</label><input type="text" class="subans ${isMany}" data-index="${i}" />`).join("")
        }</div>`;
      }
      /* â‘¤ ê°ê´€ì‹/ë³µìˆ˜í˜• â€” ê¸°ì¡´ ìœ ì§€ */
      else if(type==="ê°ê´€ì‹"){
        const opts=["â‘ ","â‘¡","â‘¢","â‘£","â‘¤"];
        inputHTML=`<div class="choices">${
          opts.map(o=>`<label><input type="radio" name="${q.id}" value="${o}">${o}</label>`).join("")
        }</div>`;
      }else if(type==="ê°ê´€ì‹(ë³µìˆ˜í˜•)"){
        const opts=["â‘ ","â‘¡","â‘¢","â‘£","â‘¤"];
        inputHTML=`<div class="choices">${
          opts.map(o=>`<label><input type="checkbox" name="${q.id}" value="${o}">${o}</label>`).join("")
        }</div>`;
      }
      /* â‘¥ ë“±ì‹í˜•/ì¼ë°˜ ë‹¨ë‹µí˜• â€” ê¸°ì¡´ ìœ ì§€ */
      else if(type==="ë“±ì‹í˜•"){
        inputHTML=`<input type="text" class="answer-input" placeholder="ì •ë‹µì„ ì…ë ¥í•˜ì„¸ìš”" />`;
      }
      /* â‘¦ íŠ¹ìˆ˜í˜•(ëª«/ë‚˜ë¨¸ì§€, ì‹¤ìˆ˜/í—ˆìˆ˜, ìµœëŒ“/ìµœì†Ÿ) â€” ê¸°ì¡´ ìœ ì§€ */
      else if(/ëª«\s*:|ë‚˜ë¨¸ì§€\s*:/.test(ans)){
        inputHTML=`<div class="dual-inputs"><label>ëª«</label><input type="text" class="ans1" />
          <label>ë‚˜ë¨¸ì§€</label><input type="text" class="ans2" /></div>`;
      }else if(/ì‹¤ìˆ˜ë¶€ë¶„\s*:|í—ˆìˆ˜ë¶€ë¶„\s*:/.test(ans)){
        inputHTML=`<div class="dual-inputs"><label>ì‹¤ìˆ˜ë¶€ë¶„</label><input type="text" class="ans1" />
          <label>í—ˆìˆ˜ë¶€ë¶„</label><input type="text" class="ans2" /></div>`;
      }else if(/ìµœëŒ“ê°’\s*:|ìµœì†Ÿê°’\s*:/.test(ans)){
        inputHTML=`<div class="dual-inputs"><label>ìµœëŒ“ê°’</label><input type="text" class="ans1" />
          <label>ìµœì†Ÿê°’</label><input type="text" class="ans2" /></div>`;
      }
      /* â‘§ ì±„ì  ë¶ˆê°€ ìœ í˜• â€” ê¸°ì¡´ ìœ ì§€ */
      else{
        inputHTML=`<input type="text" class="answer-input disabled" value="ì±„ì  ë¶ˆê°€ëŠ¥ ìœ í˜•" disabled />`;
      }

      const canGrade = (
        type.startsWith("ë³€ìˆ˜ ëŒ€ì…í˜•") || type==="ë“±ì‹í˜•" || type==="ê°ê´€ì‹" || type==="ê°ê´€ì‹(ë³µìˆ˜í˜•)" ||
        /ëª«\s*:|ë‚˜ë¨¸ì§€\s*:/.test(ans) || /ì‹¤ìˆ˜ë¶€ë¶„\s*:|í—ˆìˆ˜ë¶€ë¶„\s*:/.test(ans) || /ìµœëŒ“ê°’\s*:|ìµœì†Ÿê°’\s*:/.test(ans) ||
        /\(\d+\)|\([ê°€-ì‚¬]\)/.test(ans)
      );

      return `
        <div class="question-card" data-id="${q.id}">
          <div class="question-line">
            <h3>${q.id.replace("q","")}</h3>
            ${inputHTML}
            <button class="check-btn"${canGrade?"":" disabled"}>ì±„ì </button>
            <span class="result-inline"></span>
          </div>
          <input type="hidden" class="correct-answer" value="${ans}" />
          <input type="hidden" class="answer-type" value="${type}" />
        </div>`;
    }).join("");

    /* ===== ì±„ì  ë¡œì§ (ê¸°ì¡´ ìœ ì§€ + nê°œ íƒ€ì… ì¶”ê°€) ===== */
    function gradeQuestion(card){
      const btn=card.querySelector(".check-btn");
      const result=card.querySelector(".result-inline");
      const correct=card.querySelector(".correct-answer").value.trim();
      const type=card.querySelector(".answer-type").value.trim();
      const norm=normalize;

/* ë°©ì •ì‹(nê°œ): ë³€ìˆ˜ì¹¸ + ì¶”ê°€ì¹¸ ì „ì²´ ë©€í‹°ì…‹ ë¹„êµ */
if(/^ë³€ìˆ˜\s*ëŒ€ì…í˜•\(ë°©ì •ì‹\)\(\d+ê°œ\)$/.test(type)){
  const n=parseInt(type.match(/\((\d+)ê°œ\)/)[1]);
  const varVals=[...card.querySelectorAll(".var-eq")].map(i=>norm(i.value));
  const extraVals=[...card.querySelectorAll(".extra-eq")].map(i=>norm(i.value));
  const corrVals=[...correct.matchAll(/=\s*([^,]+)/g)].map(m=>norm(m[1]));
  const corrRoot=/(í—ˆê·¼)/.test(correct)?"í—ˆê·¼":"ì‹¤ê·¼";
  const expected=[...corrVals, ...Array(n).fill(corrRoot)];
  const user=[...varVals,...extraVals];
  if(user.length!==expected.length) return fail();
  return [...user].sort().join(",") === [...expected].sort().join(",") ? pass() : fail();
}


      /* ë°©ì •ì‹(ì¼ë°˜) */
      if(type==="ë³€ìˆ˜ ëŒ€ì…í˜•(ë°©ì •ì‹)"){
        const inputs=[...card.querySelectorAll(".var-eq")].map(i=>norm(i.value));
        const corr=[...correct.matchAll(/=\s*([^,}]+)/g)].map(m=>norm(m[1]));
        if(inputs.length!==corr.length) return fail();
        return ([...inputs].sort().join(",") === [...corr].sort().join(",")) ? pass() : fail();
      }

      /* ì—°ë¦½ë°©ì •ì‹ */
      if(type==="ë³€ìˆ˜ ëŒ€ì…í˜•(ì—°ë¦½ë°©ì •ì‹)"){
        const inputs=[...card.querySelectorAll(".var-system")].map(i=>i.value);
        return gradeSystemEquationAsMultiset(correct,inputs)?pass():fail();
      }

      /* ì†Œë¬¸í•­í˜• */
      const subInputs=card.querySelectorAll(".subans");
      if(subInputs.length>0){
        const correctParts=correct.replace(/\)\s*/g,") ")
          .split(/\(\d+\)|\([ê°€-ì‚¬]\)/)
          .map(x=>norm(x.replace(/^\)|\)$/g,""))).filter(Boolean);
        const userParts=[...subInputs].map(i=>norm(i.value));
        if(correctParts.length!==userParts.length) return fail();
        return correctParts.every((c,i)=>c===userParts[i])?pass():fail();
      }

      /* ê°ê´€ì‹ */
      if(type==="ê°ê´€ì‹"){
        const sel=card.querySelector("input[type=radio]:checked")?.value;
        return (sel===correct)?pass():fail();
      }
      /* ê°ê´€ì‹(ë³µìˆ˜í˜•) */
      if(type==="ê°ê´€ì‹(ë³µìˆ˜í˜•)"){
        const chk=[...card.querySelectorAll("input[type=checkbox]:checked")].map(i=>i.value).join("");
        return (chk===correct)?pass():fail();
      }

      /* íŠ¹ìˆ˜í˜• */
      const ans1=card.querySelector(".ans1")?.value.trim()||"";
      const ans2=card.querySelector(".ans2")?.value.trim()||"";
      if(/ëª«\s*:|ë‚˜ë¨¸ì§€\s*:/.test(correct))
        return gradeSpecialPair(correct,ans1,ans2,"ëª«","ë‚˜ë¨¸ì§€")?pass():fail();
      if(/ì‹¤ìˆ˜ë¶€ë¶„\s*:|í—ˆìˆ˜ë¶€ë¶„\s*:/.test(correct))
        return gradeSpecialPair(correct,ans1,ans2,"ì‹¤ìˆ˜ë¶€ë¶„","í—ˆìˆ˜ë¶€ë¶„")?pass():fail();
      if(/ìµœëŒ“ê°’\s*:|ìµœì†Ÿê°’\s*:/.test(correct))
        return gradeSpecialPair(correct,ans1,ans2,"ìµœëŒ“ê°’","ìµœì†Ÿê°’")?pass():fail();

      /* ë“±ì‹í˜• */
      if(type==="ë“±ì‹í˜•"){
        const user=norm(card.querySelector(".answer-input")?.value.trim()||"");
        return (user===norm(correct))?pass():fail();
      }

      result.textContent="ì±„ì  ë¶ˆê°€ëŠ¥";
      result.className="result-inline";
      return;

      function pass(){result.textContent="âœ… ì •ë‹µ!";result.classList.add("correct");btn.classList.add("correct");btn.textContent="O";disableAll();}
      function fail(){result.textContent="âŒ ì˜¤ë‹µ..";result.classList.add("wrong");btn.classList.add("wrong");btn.textContent="X";disableAll();}
      function disableAll(){btn.disabled=true;card.classList.add("graded");card.querySelectorAll("input").forEach(i=>i.disabled=true);}
    }

    /* ë²„íŠ¼ ë°”ì¸ë”© */
    document.querySelectorAll(".check-btn").forEach(btn=>{
      btn.addEventListener("click",()=>gradeQuestion(btn.closest(".question-card")));
    });
    document.getElementById("check-all").addEventListener("click",()=>{
      document.querySelectorAll(".question-card").forEach(card=>{
        const btn=card.querySelector(".check-btn");
        if(btn && !btn.disabled) gradeQuestion(card);
      });
    });

  }catch(err){
    container.innerHTML="<p style='color:red;'>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>";
  }
});
</script>
</body>
</html>
